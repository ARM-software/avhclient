---
language: python
python: 3.8

env:
  global:
    - PYTHON_VERSION: 3.8

if: (type == push AND branch == main)

stages:
  - Build
  - Lint
  - Unit Tests

# Unit tests jobs common install and script phase
_shared_install: &shared_script
install:
    - python -m pip install --upgrade pip
    - pip install -e .[dev]
_shared_script: &shared_script
script:
    - coverage run --branch -m xmlrunner -o junit discover
    - coverage xml --include="./arm/avhclient/**"

jobs:
  include:
    - stage: Build
      name: Build Distribution
      os: linux
      dist: focal
      # Install setup dependencies
      install: 
        - python -m pip install --upgrade pip
        - pip install -U setuptools twine wheel
      # Build distribution
      script:
        - python setup.py sdist bdist_wheel
        - twine check dist/*
    - stage: Lint
      name: Run PyLint checks
      os: linux
      dist: focal
      # Install dev dependencies
      install:
        - python -m pip install --upgrade pip
        - pip install -e .[dev]
      # Run pylint
      script:
        - echo "::add-matcher::.github/pylint.json"
        - pylint --exit-zero --rcfile=./pylintrc arm/avhclient tests
    - stage: Unit Tests
      name: Unit Tests - Ubuntu - Python3.8
      env:
        - AWS_DEFAULT_REGION="eu-west-1"
      os: linux
      dist: focal
      python: 3.8
      <<: *shared_install
      <<: *shared_script
    - stage: Unit Tests
      name: Unit Tests - Ubuntu - Python3.9
      env:
        - AWS_DEFAULT_REGION="eu-west-1"
      os: linux
      dist: focal
      python: 3.9
      <<: *shared_install
      <<: *shared_script
    - stage: Unit Tests
      name: Unit Tests - Ubuntu - Python3.10
      env:
        - AWS_DEFAULT_REGION="eu-west-1"
      os: linux
      dist: focal
      python: 3.10
      <<: *shared_install
      <<: *shared_script
    - stage: Unit Tests
      name: Unit Tests - macOS - Python3.8
      env:
        - AWS_DEFAULT_REGION="eu-west-1"
      os: osx
      osx_image: xcode13.3
      language: shell
      before_install: python3 --version; pip3 --version; sw_vers
      <<: *shared_install
      <<: *shared_script
        #- stage: Unit Tests
        #  name: Unit Tests - macOS - Python3.9
        #  env:
        #    - AWS_DEFAULT_REGION="eu-west-1"
        #  os: osx
        #  osx_image: xcode13.3
        #  language: shell
        #  <<: *shared_install
        #  <<: *shared_script
        #- stage: Unit Tests
        #  name: Unit Tests - macOS - Python3.10
        #  env:
        #    - AWS_DEFAULT_REGION="eu-west-1"
        #  os: osx
        #  osx_image: xcode13.3
        #  language: shell
        #  <<: *shared_install
        #  <<: *shared_script
    - stage: Unit Tests
      name: Unit Tests - Windows - Python3.8
      env:
        - AWS_DEFAULT_REGION="eu-west-1"
      os: windows
      language: shell
      before_install:
        - choco install python3
        - export PATH="/c/Python37:/c/Python37/Scripts:$PATH"
      <<: *shared_install
      <<: *shared_script
        #- stage: Unit Tests
        #  name: Unit Tests - Windows - Python3.9
        #  env:
        #    - AWS_DEFAULT_REGION="eu-west-1"
        #  os: windows
        #  language: shell
        #  <<: *shared_install
        #  <<: *shared_script
        #- stage: Unit Tests
        #  name: Unit Tests - Windows - Python3.10
        #  env:
        #    - AWS_DEFAULT_REGION="eu-west-1"
        #  os: windows
        #  language: shell
        #  <<: *shared_install
        #  <<: *shared_script
